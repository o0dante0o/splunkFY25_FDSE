version: "3.9"
services:
  prisma-storybook:
    build: 
      context: .
      dockerfile: ../../infra/visual-tests/Dockerfile.storybook
      args:
        port: 6007
        storybookfolder: storybook-static-visual-prisma
        workdir: /react-ui
    command: npx http-server storybook-static-visual-prisma --port 6007
    ports:
      - "6007:6007"
  enterprise-storybook:
    build: 
      context: .
      dockerfile: ../../infra/visual-tests/Dockerfile.storybook
      args:
        port: 6008
        storybookfolder: storybook-static-visual-enterprise
        workdir: /react-ui
    command: npx http-server storybook-static-visual-enterprise --port 6008
    ports:
      - "6008:6008"
  prisma-visual-test:
    build: 
      context: .
      dockerfile: ../../infra/visual-tests/Dockerfile.visual
      args:
        workdir: /react-ui
    env_file:
      - ./.storybook-visual/config/.env.visual
    working_dir: /react-ui
    volumes:
      - "./src:/react-ui/src"
      - "./test-reports:/react-ui/test-reports"
    depends_on:
      - prisma-storybook
    command: /bin/sh -c "npx wait-on http://prisma-storybook:6007 && yarn cache clean && yarn test-storybook -c .storybook-visual --browsers $${STORYBOOK_BROWSER} $${STORYBOOK_UPDATE_SNAPSHOT} $${STORYBOOK_MAX_WORKERS} --url http://prisma-storybook:6007 --no-index-json"
  enterprise-visual-test:
    build: 
      context: .
      dockerfile: ../../infra/visual-tests/Dockerfile.visual
      args:
        workdir: /react-ui
    env_file:
      - ./.storybook-visual/config/.env.visual
    working_dir: /react-ui
    volumes:
      - "./src:/react-ui/src"
      - "./test-reports:/react-ui/test-reports"
    depends_on:
      - enterprise-storybook
    command: /bin/sh -c "npx wait-on http://enterprise-storybook:6008 && yarn cache clean && yarn test-storybook -c .storybook-visual --browsers $${STORYBOOK_BROWSER} $${STORYBOOK_UPDATE_SNAPSHOT} $${STORYBOOK_MAX_WORKERS} --url http://enterprise-storybook:6008 --no-index-json"